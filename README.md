# Swagger generated server

## Overview
This server was generated by the [swagger-codegen](https://github.com/swagger-api/swagger-codegen) project.  By using the [OpenAPI-Spec](https://github.com/OAI/OpenAPI-Specification) from a remote server, you can easily generate a server stub.

Based on swagger generated Express server and add render react client. 

Express work as API backend and rendering ReactJs as frontend server. 

### Compile the server and client
```
npm test
```

### Running the server
To run the server, run:

```
npm start
```

To view the Swagger UI interface:

```
open http://localhost:8080/docs
```

This project leverages the mega-awesome [swagger-tools](https://github.com/apigee-127/swagger-tools) middleware which does most all the work.


### Test API
```
curl -X GET "http://localhost:5000/api/v1/users/sadfasdf" -H  "accept: application/json" -H  "Authorization: Bearer ******
```

### Updated oas3-tools version by local model
- latest version in NPM is 7 mths ago (@18Sep2020) which outdated by swagger-ui
- updated swagger-ui to latest version 3.34.0 into oas3-tools; local build oas3-tools
```
#1 clone latest oas3-tools
git clone https://github.com/bug-hunters/oas3-tools.git
#2 update swagger
git clone https://github.com/swagger-api/swagger-ui.git
#3 update oas3-tools swagger-ui package
#3.1 cd swagger-ui && cp -rf dist ../oas3-tools/src/middleware/
#3.2 delete swagger-ui folder under oas3-tools/src/middleware/
#3.3 change dist to swagger-ui
```
- involve local build packages: update package.json as below: 
```
"oas3-tools": "file:oas3-tools-2.1.3.tgz",
```

- change swagger ui default URL by updating swagger-ui/index.html
- local build oas3-tools support security configuration
```
<!-- <script>
    window.onload = function() {
      // Begin Swagger UI call region
      const ui = SwaggerUIBundle({
        url: "https://petstore.swagger.io/v2/swagger.json",
        dom_id: '#swagger-ui',
        deepLinking: true,
        presets: [
          SwaggerUIBundle.presets.apis,
          SwaggerUIStandalonePreset
        ],
        plugins: [
          SwaggerUIBundle.plugins.DownloadUrl
        ],
        layout: "StandaloneLayout"
      })
      // End Swagger UI call region

      window.ui = ui
    }
  </script> -->
  <script>
    window.onload = function() {
      function initSwaggerUi (url) {
        window.ui = SwaggerUIBundle({
          url: url,
          dom_id: '#swagger-ui',
          deepLinking: true,
          presets: [
            SwaggerUIBundle.presets.apis,
            SwaggerUIStandalonePreset
          ],
          plugins: [
            SwaggerUIBundle.plugins.DownloadUrl
          ],
          layout: "StandaloneLayout",
          validatorUrl: null
        });
      }
      var xhr = new XMLHttpRequest();
      xhr.open('HEAD', document.location.href);
      xhr.onreadystatechange = function () {
        var url = '/api-docs';
        if (xhr.readyState === XMLHttpRequest.DONE) {
          url = xhr.getResponseHeader('Swagger-API-Docs-URL');
        } else {
          console.log('Unable to get the Swagger UI URL from the server (%s): %s', xhr.status, xhr.responseText);
        }
        initSwaggerUi(url);
      };
      xhr.send(null);
    }
  </script>
```

### Express Server register in swagger configuration
```
var options = {
    routing: {
        controllers: path.join(__dirname, './controllers')
    },
    openApiValidator: {
        validateSecurity: {
            handlers: {
              bearerAuth: tokenService.TokenVerify
            }
          }
    },
    swaggerUI:{
        apiDocsPath: "/docs/openapi.json"
        
    }

};

var expressAppConfig = oas3Tools.expressAppConfig(path.join(__dirname, 'api/openapi.yaml'), options);
```

### Data return from Promise and render in React
```
#store the data via react State

  const [usersDD, userData] = useState([]);
  const [firstLoad, setFirstLoad] = useState(true);

  if (firstLoad) {
    retrieveUsers().then(function (res, err) {
      const usersDD = res;
      userData(usersDD);
    });
    setFirstLoad(false);
  }

```

### Cross-platform install of npm package sqlite3
```
https://stackoverflow.com/questions/45192449/cross-platform-install-of-npm-package-sqlite3

download linux version sqlite3;

./node_modules/.bin/node-pre-gyp install --directory=./node_modules/sqlite3 --target_platform=linux 
```

### CORS attach in browser
```
Kafkajs cannot launch in React App in browser because of CORS attack blocking
solution: need to via express server back communicate with Kafka and use websocket push back the message

Cannot search the Elastic engine because CORS attack blocking
Solution: retrieve Elastic Search via express API.

```

# Install Elastic Search in local

### Install ES
```
docker pull elasticsearch:7.9.3
```

### Start ES
```
docker run -d --name elasticsearch --net kibana -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" elasticsearch:7.9.3
```

### create ES index
```
PUT http://localhost:9200/books/_doc/2014-00285-019 -d {***input JSON body here***}

```

### Query ES
```
GET http://localhost:9200/books/_search?q=Food&sort=%7B%22createdDate%22:%7B%22order%22:%22desc%22%7D%7D&size=200
```